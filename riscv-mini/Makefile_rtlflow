default: rtlflow

MAKEFILE_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))
#mkfile_path := $(abspath $(lastword $(MAKEFILE_LIST)))
#current_dir := $(notdir $(patsubst %/,%,$(dir $(mkfile_path))))
base_dir   = $(abspath $(MAKEFILE_DIR))
src_dir    = $(base_dir)/src/main
gen_dir    = $(base_dir)/generated-src-rtlflow-vps$(VERILATOR_PARTITION_SIZE)-bs$(BATCH)-c$(NUM_CYCLES)-s$(NUM_STIMULUS)-u$(UNIT_WEIGHT)-b$(BETA)
v_dir      = $(base_dir)/generated-src

#out_dir    = $(base_dir)/outputs-rtlflow

CXXFLAGS += -std=c++17

# compile RTLflow
# -CFLAGS "$(CXXFLAGS) -O2 -DBATCH=$(BATCH) -include $(gen_dir)/VTile.csrc/VTile.h" 
RTLflow = $(VERILATOR_ROOT)/bin/rtlflow --cc --exe --threads-max-mtasks 65536 --threads $(VERILATOR_PARTITION_SIZE)
RTLflow_FLAGS = --stats -Wno-fatal -Wno-STMTDLY -O3 \
	--top-module Tile -Mdir $(gen_dir)/VTile.csrc \
	--weight_table $(WEIGHT_TABLE) \
	-CFLAGS "$(CXXFLAGS) -O2 -DBATCH=$(BATCH) -include $(gen_dir)/VTile.csrc/VTile.h" 

$(base_dir)/VTile: $(v_dir)/Tile.v $(src_dir)/cc/top.cu $(src_dir)/cc/mm.cu $(src_dir)/cc/mm.h
	rm -rf $(gen_dir)
	mkdir $(gen_dir)
	$(RTLflow) $(RTLflow_FLAGS) -o $@ $< $(word 2, $^) $(word 3, $^)
	$(MAKE) VM_PARALLEL_BUILDS=1 -j64 -C $(gen_dir)/VTile.csrc -f VTile.mk

rtlflow: $(base_dir)/VTile
	cp $(base_dir)/VTile $(OUTPUT_DIR)testbench
	cp $(gen_dir)/VTile.csrc/VTile__stats.txt $(OUTPUT_DIR)
	rm $(base_dir)/VTile

clean:
	rm -rf $(base_dir)/generated-src-rtlflow-*



.PHONY: rtlflow clean cleanall




